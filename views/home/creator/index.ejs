<script src="/js/comment/comment_user.js"></script>

<div class="content">
  <div class="creator_page">
    <div class="bg_creator">
    </div>
    <!-- <div class="bg_creator_img">
            <div class="bg_image">
                <img src="/img/bg.jpg" alt="">
            </div>
        </div> -->
    <div class="limit_creator_profile">
      <div class="creator_profile">
        <div class="creator_content">
          <img src="<%= creators[0].img %>" alt="">
          <div class="creator_detail">
            <span class="creators_name">
              <%= creators[0].creator_name %>
            </span>
            <span class="creators_desc">
              <%= creators[0].creator_desc.length > 50 ? creators[0].creator_desc.slice(0, 50) + '...' : creators[0].creator_desc %>
            </span>
            <!-- <p>5.2M Members 41 Posts</p> -->
            <p>
              <%= posts_all.length %> Posts
            </p>
          </div>
        </div>
        <div class="post">
          <% if (!checks) { %>
            <a class="btn_sub_creator">สมัคร</a>
            <% } else { %>
              <a class="btn_sub_update">อัพเดท</a>
              <% } %>
                <i id="tooltip_creator" class="material-icons">more_horiz</i>
        </div>
      </div>
    </div>

    <div class="limit_navbar">
      <%- include('./navbar.ejs')%>
    </div>

    <% if (!checks) { %>

      <% if (packages.length> 0) { %>

        <div class="limit_package_preview">
          <div class="package_preview_header">
            <span>สมัครเข้าร่วมเป็นสมาชิกกับเรา!</span>
          </div>
          <div class="package_preview_list">
            <% if (packages.length> 0) { %>
              <% for(var i=0; i < packages.length; i++) { %>
                <div class="package_preview_item">
                  <div class="package_preview_name">
                    <span>
                      <%=packages[i].package_name%>
                    </span>
                  </div>
                  <div class="package_preview_price">
                    <span>฿ <%=packages[i].package_price%> / เดือน</span>
                  </div>
                  <a href="/checkout/<%= creators[0].creator_name %>?id_package=<%=packages[i].id%>&id_creator=<%= creators[0].id %>">เข้าร่วม</a>
                  <div class="package_preview_desc">
                    <%-packages[i].package_desc%>
                  </div>
                </div>
                <% } %>
                  <%} else { %>
                    <div class="no-packages-message">No packages available.</div>
                    <% } %>
          </div>
        </div>

        <% } else { %>

          <div class="limit_package_preview">
            <div class="package_preview_header">
              <span>ยินดีต้อนรับสู่ <%= creators[0].creator_name %></span>
            </div>
          </div>

          <% } %>

            <% if (posts.length> 0) { %>

              <div class="content_feed_limit">
                <div class="content_feed">
                  <div class="header_post_creator">
                    <span>โพสต์ล่าสุดของ <%= creators[0].creator_name %></span>
                  </div>
                  <% for(var i=0; i < posts.length; i++) { %>
                    <div class="box_feed">
                      <div class="header_creator_feed">
                        <div class="creator_feed left">
                          <img src="<%= creators[0].img %>">
                          <div class="creator_info">
                            <span class="post_creator_name">
                              <%= creators[0].creator_name %>
                            </span>
                            <span class="post_time_feed_home"><%= new Date(posts[i].post_date).toLocaleString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' }) %></span>
                          </div>
                        </div>
                        <div class="tooltip right">
                          <i id="tooltip_click" class="material-icons">more_horiz</i>
                        </div>
                      </div>
                      <hr>
                      <div class="post_feed">
                        <% if (!posts[i].post_img) { %>

                          <% } else { %>
                            <div class="post_img_feed">
                              <img src="<%= posts[i].post_img %>" id="zoomable-image">
                            </div>
                            <% } %>
                              <div class="post_title_feed">
                                <span>
                                  <%= posts[i].post_title %>
                                </span>
                              </div>
                              <div class="post_desc_feed">
                                <%- posts[i].post_desc %>
                              </div>
                      </div>
                      <div class="comment_user" id="commentPost_<%= posts[i].id %>">
                      </div>
                      <script>
                        fetchComments(`<%= posts[i].id %>`);
                      </script>
                    </div>
                    <% } %>
                      <div class="limit_post">
                        <span>สิ้นสุดเนื้อหา</span>
                      </div>
                </div>
              </div>

              <% } else { %>

                <% } %>

                  <% } else { %>

                    <% if (posts.length> 0) { %>

                      <div class="content_feed_limit">
                        <div class="content_feed">
                          <% for(var i=0; i < posts.length; i++) { %>
                            <div class="box_feed">
                              <div class="header_creator_feed">
                                <div class="creator_feed left">
                                  <img src="<%= creators[0].img %>">
                                  <div class="creator_info">
                                    <span class="post_creator_name">
                                      <%= creators[0].creator_name %>
                                    </span>
                                    <span class="post_time_feed_home"><%= new Date(posts[i].post_date).toLocaleString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' }) %></span>
                                  </div>
                                </div>
                                <div class="tooltip right">
                                  <i id="tooltip_click" class="material-icons">more_horiz</i>
                                </div>
                              </div>
                              <hr>
                              <div class="post_feed">
                                <% if (!posts[i].post_img) { %>

                                  <% } else { %>
                                    <div class="post_img_feed">
                                      <img src="<%= posts[i].post_img %>" id="zoomable-image">
                                    </div>
                                    <% } %>
                                      <div class="post_title_feed">
                                        <span>
                                          <%= posts[i].post_title %>
                                        </span>
                                      </div>
                                      <div class="post_desc_feed">
                                        <%- posts[i].post_desc %>
                                      </div>
                              </div>
                              <div class="comment_user" id="commentPost_<%= posts[i].id %>">
                              </div>
                              <script>
                                fetchComments(`<%= posts[i].id %>`, `<%= SESSION_USER.id %>`);
                              </script>
                              <hr>
                              <div class="comment_post">
                                <form class="commentForm" action="/post/comment/create" method="POST">
                                  <div class="comment_user_input">
                                    <input type="hidden" name="role" value="USER">
                                    <input type="hidden" name="id_post" value="<%= posts[i].id %>">
                                    <input type="hidden" name="id_user" value="<%= SESSION_USER.id %>">
                                    <input type="hidden" name="callback" value="<%= creators[0].creator_name %>">
                                    <img src="<%= SESSION_USER.img %>" alt="profile">
                                    <textarea class="commentInput" name="comment"
                                      placeholder="แสดงความคิดเห็น..."></textarea>
                                    <div class="icon_class submitIcon">
                                      <i class="fa-solid fa-paper-plane sent_icon"></i>
                                    </div>
                                  </div>
                                </form>
                              </div>
                            </div>
                            <% } %>
                              <div class="limit_post">
                                <span>สิ้นสุดเนื้อหา</span>
                              </div>
                        </div>
                      </div>

                      <% } else { %>

                        <div class="content_feed_limit">
                          <div class="content_feed">
                            <div class="header_post_creator_no">
                              <span>ไม่มีเนื้อหา</span>
                            </div>
                          </div>
                        </div>

                        <% } %>

                          <% } %>

  </div>
</div>

<script>

  // Add the textarea resizing functionality to each comment form textarea
  document.querySelectorAll('.commentInput').forEach(textarea => {
    textarea.addEventListener('input', function () {
      this.style.height = '49px';
      const scrollHeight = this.scrollHeight;
      this.style.height = `${scrollHeight}px`;
    });
  });

  // Change the event listener for the submit button
  document.querySelectorAll('.submitIcon').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      this.closest('.commentForm').submit();
    });
  });

  // Change the event listener for the textarea to handle Enter key press
  document.querySelectorAll('.commentInput').forEach(textarea => {
    textarea.addEventListener('keydown', function (event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        this.closest('.commentForm').submit();
      }
    });
  });
  
</script>