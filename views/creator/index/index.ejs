<script src="/js/comments.js"></script>

<div class="content">
    <div class="creator_page">
        <div class="bg_creator">
        </div>
        <!-- <div class="bg_creator_img">
            <div class="bg_image">
                <img src="/img/bg.jpg" alt="">
            </div>
        </div> -->
        <div class="limit_creator_profile">
            <div class="creator_profile">
                <div class="creator_content">
                    <img src="<%= SESSION_USER.creator_img %>" alt="">
                    <div class="creator_detail">
                        <span class="creators_name">
                            <%= SESSION_USER.creator_name %>
                        </span>
                        <span class="creators_desc">
                            <%= SESSION_USER.creator_desc %>
                        </span>
                        <!-- <p>5.2M Members 41 Posts</p> -->
                        <p>
                            <%= posts.length %> Posts
                        </p>
                    </div>
                </div>
                <div class="post">
                    <a class="btn_post" id="click_post"><i class="fa-solid fa-pen-to-square fa-lg fas"></i>Create</a>
                    <i id="tooltip_creator" class="material-icons">more_horiz</i>
                </div>
            </div>
        </div>
        <div class="limit_navbar">
            <%- include('./navbar.ejs')%>
        </div>

        <div class="content_feed_limit">
            <div class="content_feed">
                <% for(var i=0; i < posts.length; i++) { %>
                    <div class="box_feed">
                        <div class="header_creator_feed">
                            <div class="creator_feed left">
                                <img src="<%= SESSION_USER.creator_img %>">
                                <div class="creator_info">
                                    <span class="post_creator_name">
                                        <%= SESSION_USER.creator_name %>
                                    </span>
                                    <span class="post_time_feed_home"><%= new Date(posts[i].post_date).toLocaleString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' }) %></span>
                                </div>
                            </div>
                            <div class="tooltip right">
                                <i onclick="ToolBarController(event, `<%= i %>`)" id="tooltip_click"
                                    class="material-icons">more_horiz</i>
                                <div class="tool_bar" id="tool_bar">
                                    <a
                                        href="/post/edit?craetor=<%= SESSION_USER.creator_name %>&post=<%= posts[i].id %>">
                                        <span><i class="fa-solid fa-pen tool_icon"></i></span>
                                        <span>แก้ไข</span>
                                    </a>
                                    <a
                                        href="/post/delete?craetor=<%= SESSION_USER.creator_name %>&post=<%= posts[i].id %>">
                                        <span><i class="fa-solid fa-trash tool_icon"></i></span>
                                        <span>ลบโพสต์</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="post_feed">
                            <% if (!posts[i].post_img) { %>

                                <% } else { %>
                                    <div class="post_img_feed">
                                        <img src="<%= posts[i].post_img %>" id="zoomable-image">
                                    </div>
                                    <% } %>
                                        <div class="post_title_feed">
                                            <span>
                                                <%= posts[i].post_title %>
                                            </span>
                                        </div>
                                        <div class="post_desc_feed">
                                            <%- posts[i].post_desc %>
                                        </div>
                        </div>
                            <div class="comment_user" id="commentPost_<%= posts[i].id %>">

                            </div>
                        <script>
                            fetchComments(`<%= posts[i].id %>`);
                        </script>
                        <hr>
                        <div class="comment_post">
                            <form class="commentForm" action="/post/comment/create" method="POST">
                                <div class="comment_user_input">
                                    <input type="hidden" name="role" value="CREATOR">
                                    <input type="hidden" name="id_post" value="<%= posts[i].id %>">
                                    <input type="hidden" name="id_creator" value="<%= SESSION_USER.creator_id %>">
                                    <input type="hidden" name="callback" value="creator">
                                    <img src="<%= SESSION_USER.creator_img %>" alt="profile">
                                    <textarea class="commentInput" name="comment"
                                        placeholder="แสดงความคิดเห็น..."></textarea>
                                    <div class="icon_class submitIcon">
                                        <i class="fa-solid fa-paper-plane sent_icon"></i>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <% } %>
                        <div class="limit_post">
                            <span>สิ้นสุดเนื้อหา</span>
                        </div>
            </div>
        </div>

    </div>
</div>

<script>
    function ToolBarController(event, index) {
        let tool_bar = document.querySelectorAll('.tool_bar')[index]; // Use querySelectorAll
        tool_bar.classList.toggle("open_toolbar");
        event.stopPropagation();
    }

    document.body.addEventListener("click", function (event) {
        let tool_bars = document.querySelectorAll('.tool_bar');
        let tooltips = document.querySelectorAll('.tooltip');
        let tooltipIcons = document.querySelectorAll('.material-icons');

        for (let i = 0; i < tool_bars.length; i++) {
            let tool_bar = tool_bars[i];
            let tooltip = tooltips[i];
            let tooltipIcon = tooltipIcons[i];

            if (!tool_bar.contains(event.target) && !tooltipIcon.contains(event.target)) {
                tool_bar.classList.remove("open_toolbar");
            }
        }
    });


    // Add the textarea resizing functionality to each comment form textarea
    document.querySelectorAll('.commentInput').forEach(textarea => {
        textarea.addEventListener('input', function () {
            this.style.height = '49px';
            const scrollHeight = this.scrollHeight;
            this.style.height = `${scrollHeight}px`;
        });
    });

    // Change the event listener for the submit button
    document.querySelectorAll('.submitIcon').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            this.closest('.commentForm').submit();
        });
    });

    // Change the event listener for the textarea to handle Enter key press
    document.querySelectorAll('.commentInput').forEach(textarea => {
        textarea.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                this.closest('.commentForm').submit();
            }
        });
    });

</script>